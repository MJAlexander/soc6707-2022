---
title: 'Week 5: Linear regression'
author: "Monica Alexander"
date: "06/02/2022"
output: pdf_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# By the end of this lab you should know 

- How to use `lm` to get estimated coefficients and $R^2$
- How to calculate an estimated outcome (Y) based on a particular value of an independent variable (X) and estimated regression coefficients
- How to plot a fitted SLR line on a scatter plot


# Read in, prepare, plot the data

We will be using the country indicators dataset again, and exploring the relationship between the total fertility rate (TFR) and child mortality in 2017. 

```{r}
library(tidyverse)
library(here)
country_ind <- read_csv(here("data/country_indicators.csv"))

# NOTE if you are having trouble with the 'here' package
# don't use it and just type in the whole file path. 

```


## Filter to just be 2017

```{r}
country_ind_2017 <- country_ind %>% filter(year==2017)
```

## Look at the observed relationship between TFR and child mortality

```{r}
ggplot(country_ind_2017, aes(tfr, child_mort)) + 
  geom_point()
```

## Question

Alter the code above to make a plot title and make the X and Y axes more readable. 

```{r}
ggplot(country_ind_2017, aes(tfr, child_mort)) + 
  geom_point() +
  labs(title = "Child mortality versus TFR, 2017", 
       x = "total fertility rate (births per woman)",
       y = "child mortality rate (deaths per 1000 births)")
```

# Estimating SLR using `lm`

We don't have to calculate the regression coefficients or $R^2$ 'by hand', we can just use the `lm` function. ('lm' stands for 'linear models').

The main arguments are

- The formula, which is written in the form `y~x` 
- The data frame that contains the variables 

Fit our SLR:

```{r}
childmort_tfr_model <- lm(formula = child_mort~tfr, data = country_ind_2017)
childmort_tfr_model
```

Print out the summary:

```{r}
summary(childmort_tfr_model)
```


## Extract results

To extract coefficients from the model output, use the `coef()` function

```{r}
coef(childmort_tfr_model)
```

Can assign these to variables by indexing the relevant number:

```{r}
beta_0 <- coef(childmort_tfr_model)[1] # the [1] means get the first item
beta_1 <- coef(childmort_tfr_model)[2] 

beta_0
beta_1
```

- What's the interpretation of $\beta_0$? The expected value of child mortality for a country with a TFR = 0 is -25.83 deaths per 1000 births. CAN'T HAVE NEGATIVE CHILD MORTALITY??? But this is okay, because we're never going to have a country with TFR = 0. 
- What's the interpretation of $\beta_1$? For every 1 child increase in TFR, the expected value of child mortality increases by 20.36 deaths/1000 live births. 
- If TFR increased by 2 children, what's the expected change in child mortality? 40.7

```{r}
2*beta_1
```




## Question

What is the estimated child mortality for a country with a TFR of 5? ANSWER: 76.0

Estimated regression model is $-25.8 + 20.4*X$ where X is TFR

```{r}
beta_0 + beta_1*5
```


# Plotting the fitted line on a scatter plot

To visualize our fitted line we can add to our plot from before using `geom_abline`

```{r}
ggplot(country_ind_2017, aes(tfr, child_mort)) + 
  geom_point() + 
  geom_abline(intercept = beta_0, slope = beta_1, color = "red")
```

# More on categorical covariates

Read in GSS

```{r}
gss <- read_csv(here("data/gss.csv"))
unique(gss$educ_cat) # see what the levels of educ_cat

```

Let's look at age at first birth in relation to education.

Baseline category is bachelor degree. So all coefficient estimates in this model are interpreted in relation to the baseline category. 

- Intercept: the expected value (population mean) of age at first birth for baseline category = people with a bachelor degree: 29.4 years. 
- Interpret high school: compared to people with a bachelor degree, people with just high school have an expected value of age at first birth of 3.9 years less 

```{r}
gss <- gss %>% drop_na(educ_cat)

mod_educ <- lm(age_at_first_birth ~ educ_cat, data = gss)
summary(mod_educ)  
```

Change the baseline category: easiest way to do this is to reorder the categories using `fct_relevel`


JUST CHANGING BASELINE (FIRST) CATEGORY
```{r}
unique(gss$educ_cat)

gss <- gss %>% 
  mutate(educ_cat = fct_relevel(educ_cat, "high school", 
                                after = 0)) # put high school first


mod_educ <- lm(age_at_first_birth ~ educ_cat, data = gss)
summary(mod_educ)

```
ORDERED IN A SENSIBLE WAY

```{r}
educ_levels <- c("less than high school",
                 "high school",
                 "trade or other certificate",
                 "some university",
                 "bachelor",
                 "postgraduate")
gss <- gss %>% 
  mutate(educ_cat = fct_relevel(educ_cat, educ_levels))
mod_educ <- lm(age_at_first_birth ~ educ_cat, data = gss)
summary(mod_educ)

```


# Multiple linear regression

Running MLR in R is an easy extension of SLR. Here are some practice questions using the `lego_towers` dataset. This dataset shows observations of the time (in seconds) it took my toddler to build a lego tower, the number of blocks given to him, and the number of other distractions present. 

Reading in the data:

```{r}
lego <- read_csv(here("data/lego_towers.csv"))
```
## Questions

1. Make a scatter plot of time versus blocks
2. Make a scatter plot of time versus distractions
3. Based on 1 and 2, what do you expect the magnitude and sign (direction) of $\hat{\beta_1}$ and $\hat{\beta_2}$ to be?
4. Fit the above model using `lm`
5. Interpret $\hat{\beta_1}$ and $\hat{\beta_2}$
6. Using `mutate` create a new variable called `blocks_3` which is the number of blocks minus 3
7. Refit the model using `lm` where $X_{i1}$ is now `blocks_3`
8. Interpret $\hat{\beta_0}$

